{% extends 'base.html' %}

{% block content %}
    <h2>Search Results</h2>

    {% if search_description and not search_description.startswith("Error:") %}
        <div class="alert alert-info">
            <strong>AI Description of Your Item:</strong> {{ search_description }}
        </div>
    {% elif search_description %}
         <div class="alert alert-warning">
            <strong>AI Description Failed:</strong> {{ search_description }} (Matching quality may be reduced)
        </div>
    {% endif %}


    {% if matches %}
        <p>Found {{ matches|length }} potential match(es) based on your search criteria. Please review carefully.</p>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for match in matches %}
                <div class="col">
                    <div class="card h-100">
                        <img src="{{ url_for('uploaded_file', filename=match.found_item.image_filename) }}" class="card-img-top" alt="Found Item Image" style="max-height: 250px; object-fit: contain; padding: 10px;">
                        <div class="card-body">
                            <h5 class="card-title">Potential Match: {{ match.found_item.item_type }}</h5>
                            <p class="card-text">
                                <strong>AI Description:</strong> {{ match.found_item.ai_description | truncate(150) }}<br>
                                <strong>Color:</strong> {{ match.found_item.color | default('N/A') }}<br>
                                <strong>Brand:</strong> {{ match.found_item.brand | default('N/A') }}<br>
                                <strong>Location Found:</strong> {{ match.found_item.location }}<br>
                                <strong>Reported:</strong> {{ match.found_item.timestamp.strftime('%Y-%m-%d %H:%M') }}
                            </p>
                            <p class="card-text">
                                <span class="badge bg-success">Match Confidence: {{ "%.2f"|format(match.confidence * 100) }}%</span> <br>
                                <small class="text-muted">
                                    Desc: {{ "%.2f"|format(match.scores.description) }} |
                                    Meta: {{ "%.2f"|format(match.scores.metadata) }} |
                                    Img: {{ "%.2f"|format(match.scores.image) }}
                                </small>
                            </p>
                            <div class="alert alert-warning mt-3">
                                <strong>Finder's Contact:</strong> {{ match.found_item.contact_info }}
                                <br><small>Please be respectful when contacting the finder.</small>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-secondary">
            <p>No strong matches found in the database for your item based on the current criteria.</p>
            <p>Tips:</p>
            <ul>
                <li>Try uploading a clearer or different reference image.</li>
                <li>Adjust the details you provided (e.g., broaden location description).</li>
                <li>Check back later, as new items are reported frequently.</li>
            </ul>
        </div>
    {% endif %}

    <div class="mt-4">
        <a href="{{ url_for('search_lost') }}" class="btn btn-secondary">Start a New Search</a>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back to Home</a>
    </div>

{% endblock %}